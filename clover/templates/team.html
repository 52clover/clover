{% extends 'base.html' %}

{% block style %}
<style>
  body {
    margin: 10px;
  }
  .demo-carousel {
    height: 200px;
    line-height: 200px;
    text-align: center;
  }
  #create_variable_dialog {
    display: none;
  }
  </style>
{% endblock %}

{% block content %}
<table class="layui-hide" id="list" lay-filter="list"></table>

<div id="team_dialog" style="display: none;">
  <form class="layui-form" action="">
    <div class="layui-form-item">
      <label class="layui-form-label">团队名称：</label>
      <div class="layui-input-block">
        <input type="text" id="team" required  lay-verify="required" placeholder="请输入团队名称" autocomplete="off" class="layui-input">
      </div>
    </div>
    <div class="layui-form-item">
      <label class="layui-form-label">项目名称：</label>
      <div class="layui-input-block">
        <input type="text" id="project" required  lay-verify="required" placeholder="请输入项目名称" autocomplete="off" class="layui-input">
      </div>
    </div>
  </form>
</div>

<script type="text/html" id="tool">
  <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="add">添加</a>
  <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="delete">删除</a>
</script>

<script>
//layui.extend({
//  excel: '{/}/static/layui/ext/excel',
//  soulTable: '{/}/static/layui/ext/soulTable',
//  tableChild: '{/}/static/layui/ext/tableChild',
//  tableFilter: '{/}/static/layui/ext/tableFilter',
//  tableMerge: '{/}/static/layui/ext/tableMerge',
//})

layui.use(['jquery', 'form', 'layer', 'table', 'soulTable'], function(){
  var $ = layui.$      //jquery
  ,form = layui.form   //表单
  ,layer = layui.layer //弹层
  ,table = layui.table //表格
  ,soulTable = layui.soulTable

  //执行一个 table 实例
  var tableIns = table.render({
    elem: '#list'
    ,id: 'list'
    ,height: 420
    ,url: '/environment/api/v1/search' //数据接口
    ,where: {type:'team', page: 0, limit: 20}
    ,title: '团队配置'
    ,page: true //开启分页
    ,toolbar: 'default' //开启工具栏，此处显示默认图标，可以自定义模板，详见文档
    ,cols: [[ //表头
      {type: 'checkbox', fixed: 'left'}
      ,{field: '_id', title: 'ID', width:200}
      ,{field: 'team', title: '团队', width:200}
      ,{field: 'project', title: '项目', width: 200, sort: true, totalRow: true}
      ,{fixed: 'right', width: 165, align:'center', toolbar: '#tool'}
    ]]
    ,parseData: function(res){ //res 即为原始返回的数据
      return {
        "code": res.status, //解析接口状态
        "msg": res.message, //解析提示文本
        "count": res.data.length, //解析数据长度
        "data": res.data //解析数据列表
      };
    }
    ,done: function () {
        soulTable.render(this)
    }
  });

  //监听头工具栏事件
  table.on('toolbar(list)', function(obj){
    var checkStatus = table.checkStatus(obj.config.id)
    ,data = checkStatus.data; //获取选中的数据
    switch(obj.event){
      case 'add':
        layer.open({
          type: 1,
          skin: 'layui-layer-rim', //加上边框
          area: ['400px', '320px'], //宽高
          content: $('#team_dialog'),
          btn: '创建配置',
          yes: function(index, layero) {
            var url = "/environment/api/v1/create"
            var data = {
              'team': $('#team').val(),
              'project': $('#project').val(),
              'type': "team"
            }
            http(url, data, 'POST', function(data){
              if (data.status != 0) {
                layer.msg(data.message);
              } else {
                layer.msg(data.message);
              }
              tableIns.reload({
                url: '/environment/api/v1/search'
                ,where: {type: 'team', page: 0, limit: 20}
              });
            }, function(data){
              layer.msg("创建配置失败，请联系平台管理员！");
            })
            layer.close(index); //如果设定了yes回调，需进行手工关闭
          },
          success: function(layero, index){
            $('#team_dialog').css("display", "block");
          }
        });
        form.render();
      break;
      case 'update':
        if(data.length === 0){
          layer.msg('请选择一行');
        } else if(data.length > 1){
          layer.msg('只能同时编辑一个');
        } else {
          /*
          * 这里应该使用数据填充到弹框里，然后保存弹框时将数据更新。
          */
          layer.open({
          type: 1,
          skin: 'layui-layer-rim', //加上边框
          area: ['400px', '320px'], //宽高
          content: $('#team_dialog'),
          btn: '更新配置',
          yes: function(index, layero) {
            var url = "/environment/api/v1/update"
            var data = {
              '_id': checkStatus.data[0]._id,
              'team': $('#team').val(),
              'project': $('#project').val(),
              'type': 'team'
            }
            http(url, data, 'POST', function(data){
              console.log(data)
              if (data.status != 0) {
                layer.msg(data.message);
              } else {
                layer.msg(data.message);
              }
              tableIns.reload({
                url: '/environment/api/v1/search'
                ,where: {type: 'team', page: 0, limit: 20}
              });
            }, function(data){
              layer.msg("更新配置失败，请联系平台管理员！");
            })
            layer.close(index); //如果设定了yes回调，需进行手工关闭
          },
          success: function(layero, index){
            $('#team').val(checkStatus.data[0].team)
            $('#project').val(checkStatus.data[0].project)
            $('#team_dialog').css("display", "block");
          }
        });
        form.render();
        }
      break;
      case 'delete':
        if(data.length === 0){
          layer.msg('请选择一行');
        } else {
          layer.open({
          type: 1,
          btn: '删除配置',
          yes: function(index, layero) {
            var data = {
              'type': "team",
              'id_list': []
            }
            console.log(checkStatus)
            for (var index=0; index<checkStatus.data.length; index++) {
              console.log(checkStatus.data[index])
              data['id_list'].push(checkStatus.data[index]._id)
            }
            console.log(data)
            var url = "/environment/api/v1/delete"
            http(url, data, 'POST', function(data){
              console.log(data)
              if (data.status != 0) {
                layer.msg(data.message);
              } else {
                layer.msg(data.message);
              }
              tableIns.reload({
                url: '/environment/api/v1/search'
                ,where: {type: 'team', page: 0, limit: 20}
              });
            }, function(data){
              layer.msg("删除配置失败，请联系平台管理员！");
            })
            layer.close(index); //如果设定了yes回调，需进行手工关闭
          }
        });
        form.render();
        }
      break;
    };
  });

  //监听行工具事件
  table.on('tool(list)', function(obj){ //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
    var data = obj.data //获得当前行数据
    ,layEvent = obj.event; //获得 lay-event 对应的值
    if(layEvent === 'add'){
      layer.open({
          type: 1,
          skin: 'layui-layer-rim', //加上边框
          area: ['400px', '320px'], //宽高
          content: $('#team_dialog'),
          btn: '创建配置',
          yes: function(index, layero) {
            var url = "/environment/api/v1/create"
            var data = {
              'team': $('#team').val(),
              'project': $('#project').val(),
              'type': 'team'
            }
            http(url, data, 'POST', function(data){
              if (data.status != 0) {
                layer.msg(data.message);
              } else {
                layer.msg(data.message);
              }
              tableIns.reload({
                url: '/environment/api/v1/search'
                ,where: {type: 'team', page: 0, limit: 20}
              });
            }, function(data){
              layer.msg("创建配置失败，请联系平台管理员！");
            })
            layer.close(index); //如果设定了yes回调，需进行手工关闭
          },
          success: function(layero, index){
            $('#my_dialog').css("display", "block");
          }
        });
        form.render();
    } else if(layEvent === 'delete'){
      layer.open({
          type: 1,
          btn: '删除配置',
          yes: function(index, layero) {
            var item = {
              'type': "team",
              'id_list': [data._id]
            }
            var url = "/environment/api/v1/delete"
            http(url, item, 'POST', function(data){
              console.log(data)
              if (data.status != 0) {
                layer.msg(data.message);
              } else {
                layer.msg(data.message);
              }
              tableIns.reload({
                url: '/environment/api/v1/search'
                ,where: {type: 'team', page: 0, limit: 20}
              });
            }, function(data){
              layer.msg("删除配置失败，请联系平台管理员！");
            })
            layer.close(index); //如果设定了yes回调，需进行手工关闭
          }
        });
        form.render();
    } else if(layEvent === 'edit'){
      console.log(data)
      layer.open({
          type: 1,
          skin: 'layui-layer-rim', //加上边框
          area: ['400px', '320px'], //宽高
          content: $('#team_dialog'),
          btn: '更新配置',
          yes: function(index, layero) {
            var url = "/environment/api/v1/update"
            var item = {
              '_id': data._id,
              'team': $('#team').val(),
              'project': $('#project').val(),
              'type': "team"
            }
            http(url, item, 'POST', function(data){
              console.log(item)
              if (data.status != 0) {
                layer.msg(data.message);
              } else {
                layer.msg(data.message);
              }
              tableIns.reload({
                url: '/environment/api/v1/search'
                ,where: {type: 'team', page: 0, limit: 20}
              });
            }, function(data){
              layer.msg("更新配置失败，请联系平台管理员！");
            })
            layer.close(index); //如果设定了yes回调，需进行手工关闭
          },
          success: function(layero, index){
            $('#team').val(data.team)
            $('#project').val(data.project)
            $('#team_dialog').css("display", "block");
          }
        });
        form.render();
    }
  });
});
</script>
{% endblock %}