{% extends 'base.html' %}

{% block style %}
<style>
  body {
    margin: 10px;
  }
  </style>
{% endblock %}

{% block script %}
  <script src="/static/js/environment.js"></script>
{% endblock %}

{% block content %}
<table class="layui-hide" id="list" lay-filter="list"></table>

<script type="text/html" id="tool">
  <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="add">添加</a>
  <a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="delete">删除</a>
</script>

<script>
layui.use(['jquery', 'form', 'layer', 'table'], function(){
  var $ = layui.$      //jquery
  ,form = layui.form   //表单
  ,layer = layui.layer //弹层
  ,table = layui.table //表格

  form.on('select(team)', function(data){
	var url = "/environment/api/v1/search"
    var data = {
      "type": "team",
      "team": $("#team").val()
    }
    http(url, data, 'GET', function(data) {
      $('#project').empty()
      var html = ""
      for (key in data['data']) {
        html += '<option value="' + data['data'][key]['project'] + '">' + data['data'][key]['project'] + '</option>'
      }
      $('#project').append(html)
      form.render();
    }, function(data) {
      console.log(data)
    })
  });

  //执行一个 table 实例
  var tableIns = table.render({
    elem: '#list'
    ,height: 420
    ,url: '/environment/api/v1/search' //数据接口
    ,where: {type: 'snippet', page: 0, limit: 20}
    ,title: '全局变量'
    ,page: true //开启分页
    ,toolbar: 'default' //开启工具栏，此处显示默认图标，可以自定义模板，详见文档
    ,cols: [[ //表头
      {type: 'checkbox', fixed: 'left'}
      ,{field: '_id', title: 'ID', width:280, sort: true, fixed: 'left', totalRowText: '合计：'}
      ,{field: 'team', title: '团队', width:200}
      ,{field: 'project', title: '项目', width: 200, sort: true, totalRow: true}
      ,{field: 'name', title: '变量', width:200, sort: true}
      ,{field: 'value', title: '值', width:200, sort: true}
      ,{fixed: 'right', width: 165, align:'center', toolbar: '#tool'}
    ]]
    ,parseData: function(res){ //res 即为原始返回的数据
      return {
        "code": res.status, //解析接口状态
        "msg": res.message, //解析提示文本
        "count": res.data.length, //解析数据长度
        "data": res.data //解析数据列表
      };
    }
  });

  //监听头工具栏事件
  table.on('toolbar(list)', function(obj){
    var checkStatus = table.checkStatus(obj.config.id)
    ,data = checkStatus.data; //获取选中的数据
    switch(obj.event){
      case 'add':
        layer.open({
          type: 1,
          skin: 'layui-layer-rim', //加上边框
          area: ['400px', '320px'], //宽高
          content: $('#variable_dialog'),
          btn: '创建变量',
          yes: function(index, layero) {
            var url = "/environment/api/v1/create"
            var data = {
              'type': 'variable',
              'team': $('#team').val(),
              'project': $('#project').val(),
              'name': $('#name').val(),
              'value': $('#value').val()
            }
            http(url, data, 'POST', function(data){
              if (data.status != 0) {
                layer.msg(data.message);
              } else {
                layer.msg(data.message);
              }
              tableIns.reload({
                url: '/environment/api/v1/search'
                ,where: {type: 'variable', page: 0, limit: 20}
              });
            }, function(data){
              layer.msg("创建变量失败，请联系平台管理员！");
            })
            layer.close(index); //如果设定了yes回调，需进行手工关闭
          },
          success: function(layero, index){
            $('#variable_dialog').css("display", "block");
          }
        });
        form.render();
      break;
      case 'update':
        if(data.length === 0){
          layer.msg('请选择一行');
        } else if(data.length > 1){
          layer.msg('只能同时编辑一个');
        } else {
          /*
          * 这里应该使用数据填充到弹框里，然后保存弹框时将数据更新。
          */
          layer.open({
          type: 1,
          skin: 'layui-layer-rim', //加上边框
          area: ['400px', '320px'], //宽高
          content: $('#variable_dialog'),
          btn: '更新变量',
          yes: function(index, layero) {
            var url = "/environment/api/v1/update"
            var data = {
              'type': 'variable',
              '_id': checkStatus.data[0]._id,
              'team': $('#team').val(),
              'project': $('#project').val(),
              'name': $('#name').val(),
              'value': $('#value').val()
            }
            http(url, data, 'POST', function(data){
              console.log(data)
              if (data.status != 0) {
                layer.msg(data.message);
              } else {
                layer.msg(data.message);
              }
              tableIns.reload({
                url: '/environment/api/v1/search'
                ,where: {type: 'variable', page: 0, limit: 20}
              });
            }, function(data){
              layer.msg("更新变量失败，请联系平台管理员！");
            })
            layer.close(index); //如果设定了yes回调，需进行手工关闭
          },
          success: function(layero, index){
            $('#team').val(checkStatus.data[0].team)
            $('#project').val(checkStatus.data[0].project)
            $('#name').val(checkStatus.data[0].name)
            $('#value').val(checkStatus.data[0].value)
            $('#variable_dialog').css("display", "block");
          }
        });
        form.render();
        }
      break;
      case 'delete':
        if(data.length === 0){
          layer.msg('请选择一行');
        } else {
          layer.open({
          type: 1,
          btn: '删除变量',
          yes: function(index, layero) {
            var data = {
              'type': 'variable',
              'id_list': []
            }
            console.log(checkStatus)
            for (var index=0; index<checkStatus.data.length; index++) {
              console.log(checkStatus.data[index])
              data['id_list'].push(checkStatus.data[index]._id)
            }
            console.log(data)
            var url = "/environment/api/v1/delete"
            http(url, data, 'POST', function(data){
              console.log(data)
              if (data.status != 0) {
                layer.msg(data.message);
              } else {
                layer.msg(data.message);
              }
              tableIns.reload({
                url: '/environment/api/v1/search'
                ,where: {type: 'variable', page: 0, limit: 20}
              });
            }, function(data){
              layer.msg("删除变量失败，请联系平台管理员！");
            })
            layer.close(index); //如果设定了yes回调，需进行手工关闭
          }
        });
        form.render();
        }
      break;
    };
  });

  //监听行工具事件
  table.on('tool(list)', function(obj){ //注：tool 是工具条事件名，test 是 table 原始容器的属性 lay-filter="对应的值"
    var data = obj.data //获得当前行数据
    ,layEvent = obj.event; //获得 lay-event 对应的值
    if(layEvent === 'add'){
      layer.open({
          type: 1,
          skin: 'layui-layer-rim', //加上边框
          area: ['400px', '320px'], //宽高
          content: $('#variable_dialog'),
          btn: '创建变量',
          yes: function(index, layero) {
            var url = "/environment/api/v1/create"
            var data = {
              'type': 'variable',
              'team': $('#team').val(),
              'project': $('#project').val(),
              'name': $('#name').val(),
              'value': $('#value').val()
            }
            http(url, data, 'POST', function(data){
              if (data.status != 0) {
                layer.msg(data.message);
              } else {
                layer.msg(data.message);
              }
              tableIns.reload({
                url: '/environment/api/v1/search'
                ,where: {type: 'variable', page: 0, limit: 20}
              });
            }, function(data){
              layer.msg("创建变量失败，请联系平台管理员！");
            })
            layer.close(index); //如果设定了yes回调，需进行手工关闭
          },
          success: function(layero, index){
            $('#variable_dialog').css("display", "block");
          }
        });
        form.render();
    } else if(layEvent === 'delete'){
      layer.open({
          type: 1,
          btn: '删除变量',
          yes: function(index, layero) {
            var item = {
              'type': 'variable',
              'id_list': [data._id]
            }
            var url = "/environment/api/v1/delete"
            http(url, item, 'POST', function(data){
              console.log(data)
              if (data.status != 0) {
                layer.msg(data.message);
              } else {
                layer.msg(data.message);
              }
              tableIns.reload({
                url: '/environment/api/v1/search'
                ,where: {type: 'variable', page: 0, limit: 20}
              });
            }, function(data){
              layer.msg("删除变量失败，请联系平台管理员！");
            })
            layer.close(index); //如果设定了yes回调，需进行手工关闭
          }
        });
        form.render();
    } else if(layEvent === 'edit'){
      console.log(data)
      layer.open({
          type: 1,
          skin: 'layui-layer-rim', //加上边框
          area: ['400px', '320px'], //宽高
          content: $('#variable_dialog'),
          btn: '更新变量',
          yes: function(index, layero) {
            var url = "/environment/api/v1/update"
            var item = {
              '_id': data._id,
              'type': 'variable',
              'team': $('#team').val(),
              'project': $('#project').val(),
              'name': $('#name').val(),
              'value': $('#value').val()
            }
            http(url, item, 'POST', function(data){
              console.log(item)
              if (data.status != 0) {
                layer.msg(data.message);
              } else {
                layer.msg(data.message);
              }
              tableIns.reload({
                url: '/environment/api/v1/search'
                ,where: {type: 'variable', page: 0, limit: 20}
              });
            }, function(data){
              layer.msg("更新变量失败，请联系平台管理员！");
            })
            layer.close(index); //如果设定了yes回调，需进行手工关闭
          },
          success: function(layero, index){
            $('#team').val(data.team)
            $('#project').val(data.project)
            $('#name').val(data.name)
            $('#value').val(data.value)
            $('#variable_dialog').css("display", "block");
          }
        });
        form.render();
    }
  });
});
</script>
{% endblock %}